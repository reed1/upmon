- name: Deploy Upmon backend
  hosts: all
  gather_facts: no
  become: no

  tasks:
    - name: Install backend Python dependencies
      ansible.builtin.command:
        cmd: ~/.local/bin/uv sync --frozen
        chdir: "{{ app_dir }}"
      tags: [push-backend]

    - name: Template backend .env.local
      ansible.builtin.template:
        src: backend.env.local.j2
        dest: "{{ app_dir }}/backend/.env.local"
        mode: "0600"
      notify: restart backend
      tags: [push-backend]

    - name: Template backend service
      ansible.builtin.template:
        src: upmon-backend.service.j2
        dest: ~/.config/systemd/user/upmon-backend.service
        mode: "0644"
      notify:
        - reload systemd
        - restart backend
      tags: [push-backend]

    - name: Enable and start backend
      ansible.builtin.systemd:
        name: upmon-backend
        enabled: true
        state: started
        scope: user

  handlers:
    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
        scope: user

    - name: restart backend
      ansible.builtin.systemd:
        name: upmon-backend
        state: restarted
        scope: user
